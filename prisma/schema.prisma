generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// SQLite connector doesn't support enums; use String.

model User {
  id          String         @id @default(cuid())
  sessionId   String         @unique
  createdAt   DateTime       @default(now())
  drillSessions DrillSession[]
  scenarios   Scenario[]
  opponents   OpponentProfile[]
}

model Scenario {
  id                 String        @id @default(cuid())
  name               String

  /// "6max" | "9max" (MVP as string)
  tableType          String        @default("6max")

  /// Hero position (e.g. BTN/CO/HJ/UTG/SB/BB)
  position           String

  /// Optional villains involved in the spot (e.g. ["BB"], ["SB","BB"]) 
  villainPositionsJson String      @default("[]")

  stackBb            Int
  players            Int

  /// Human-readable summary. Keep for backward compatibility with heuristics.
  preflopAction      String

  /// Structured description for type-A trees (SRP/3BP/4BP etc.)
  preflopConfigJson  String?

  /// Training node (MVP): e.g. FLOP_OOP, FLOP_IP, TURN, RIVER
  trainingNode       String        @default("FLOP_CBET")

  flopTexture        String
  flopTextureWeightsJson String    @default("{}")

  /// Board profile weights beyond suit texture (MVP): {"dry":0.5,"wet":0.5,"high":0.5,"low":0.5}
  boardProfileWeightsJson String   @default("{}")

  opponentTagsJson   String        @default("[]")
  weight             Int           @default(1)
  parentId           String?
  userId             String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  parent             Scenario?     @relation("ScenarioParent", fields: [parentId], references: [id])
  children           Scenario[]    @relation("ScenarioParent")
  user               User?         @relation(fields: [userId], references: [id])
  drillSessions      DrillSession[]
  drillHands         DrillHand[]

  @@index([userId])
  @@index([parentId])
}

model DrillSession {
  id         String      @id @default(cuid())
  userId     String
  scenarioId String
  createdAt  DateTime    @default(now())

  user       User        @relation(fields: [userId], references: [id])
  scenario   Scenario    @relation(fields: [scenarioId], references: [id])
  hands      DrillHand[]

  @@index([userId])
  @@index([scenarioId])
}

model DrillHand {
  id                   String       @id @default(cuid())
  sessionId            String
  scenarioId           String
  heroHand             String
  boardTexture         String

  /// Mixed strategy recommendation, e.g. {"CHECK":0.45,"BET_25":0.35,"BET_75":0.20}
  recommendedStrategyJson String   @default("{}")
  recommendationReason String

  /// User selected one action token, e.g. CHECK/BET_25/BET_33/BET_66/BET_75
  userAction           String?
  result               String?
  spotJson             String       @default("{}")
  createdAt            DateTime     @default(now())

  session              DrillSession @relation(fields: [sessionId], references: [id])
  scenario             Scenario     @relation(fields: [scenarioId], references: [id])

  @@index([sessionId])
  @@index([scenarioId])
}

model OpponentProfile {
  id            String        @id @default(cuid())
  userId        String
  name          String
  notes         String        @default("")
  hands         Int           @default(0)
  vpipCount     Int           @default(0)
  pfrCount      Int           @default(0)
  threeBetCount Int           @default(0)
  cbetCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id])
  histories     HandHistory[]

  @@index([userId])
}

model HandHistory {
  id          String           @id @default(cuid())
  opponentId  String
  rawText     String
  parsedAt    DateTime         @default(now())
  createdAt   DateTime         @default(now())

  opponent    OpponentProfile  @relation(fields: [opponentId], references: [id])

  @@index([opponentId])
}
